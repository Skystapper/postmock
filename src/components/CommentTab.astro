<div class="tab-pane fade" id="comment-tab">
  <div class="mockup-header">
    <h2>Comment Chain</h2>
    <p>Create a realistic comment chain mockup by editing the content below.</p>
    <!-- Theme Controls -->
    <div class="theme-section mb-3">
      <div class="theme-controls">
        <div class="theme-selector">
          <span class="control-label">Theme:</span>
          <div class="theme-toggle-group">
            <input type="radio" class="theme-toggle" name="comment-theme" id="comment-theme-light" value="light">
            <label class="theme-toggle-btn" for="comment-theme-light" title="Light theme">
              <i class="bi bi-sun"></i>
            </label>
            
            <input type="radio" class="theme-toggle" name="comment-theme" id="comment-theme-dim" value="dim">
            <label class="theme-toggle-btn" for="comment-theme-dim" title="Dim theme">
              <i class="bi bi-moon-stars"></i>
            </label>
            
            <input type="radio" class="theme-toggle" name="comment-theme" id="comment-theme-dark" value="dark" checked>
            <label class="theme-toggle-btn" for="comment-theme-dark" title="Dark theme">
              <i class="bi bi-moon"></i>
            </label>
          </div>
        </div>

        <div class="preview-controls">
          <button class="comment-preview-btn" id="comment-preview-btn" onclick="showCommentPreviewModal('comment')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
            </svg>
            Preview
          </button>
          <button class="randomize-btn" onclick="randomizeCommentStats()">
            <i class="bi bi-shuffle"></i>
            Randomize Stats
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="comment-wrapper">
    <div class="comment-container" data-theme="dark" id="cmtContent">
      <!-- Parent Comment -->
      <div class="commentBlock closestComment clearfix">
        <div class="topCommentBlock clearfix">
          <div class="userWrap">
            <div class="boxUserComments">
              <span class="userLink marked clearfix">
                <img class="commentAvatarImg" 
                  src="https://ei.phncdn.com/pics/users/default/pornhub/(m=bJWsSeKlbyaT)(mh=4N6NZAtseWL0p9UF)male.jpg" 
                  loading="lazy" 
                  alt="unknown"
                  onclick="uploadCommentProfilePic(this, 'unknown')"
                  style="cursor: pointer;"
                  title="Click to change profile picture">
                <span class="toggle-verify-badge" onclick="toggleVerification(this)" title="Toggle verification badge">
                  <img src="https://ei.phncdn.com/www-static/images/verified-badge.svg?cache=2025041602" alt="verified">
                </span>
              </span>
            </div>
            <div class="usernameWrap clearfix">
              <span class="usernameBadgesWrapper">
                <span class="username unknown" contenteditable="true">unknown</span>
              </span>
              <div class="date" contenteditable="true">10 years ago</div>
            </div>
          </div>

          <div class="commentMessage">
            <span contenteditable="true">What the fuck? He fucked her without removing her bra?</span>
            <div class="actionButtonsBlock">
              <a class="gtm-event-watch-page tooltipTrig float-left commentBtn buttonClass generalBtn thumbsUp thumbs">
                <i class="ph-icon-thumb-up"></i>
              </a>
              <span class="rightMargin float-left voteTotal" contenteditable="true">719</span>
              <a class="tooltipTrig rightMargin float-left commentBtn buttonClass generalBtn thumbsDown thumbs">
                <i class="ph-icon-thumb-down"></i>
              </a>
              <div class="rightMargin float-left replyBlock">
                <a class="commentBtn buttonClass generalBtn reply">
                  <span>Reply</span>
                </a>
              </div>
            </div>
          </div>

          <div class="buttonBlockRight clearfix">
            <button data-title="Report" class="tooltipTrig commentBtn buttonClass generalBtn reportBtn flag float-left">
              <i class="ph-icon-flag"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Nested Comments -->
      <div class="nestedBlock childrenOf19595421">
        <!-- First Reply -->
        <div class="clearfix">
          <div class="commentBlock closestComment clearfix">
            <div class="topCommentBlock clearfix">
              <div class="userWrap">
                <div class="boxUserComments verified-user">
                  <a class="userLink clearfix">
                    <img class="commentAvatarImg" 
                      src="https://ei.phncdn.com/(m=bLWsSeKlbyaT)(mh=GPkFbwcjNQFQ5N3Q)5e08a2b4-39df-4f19-b9a3-d44a020fec1f.jpg" 
                      loading="lazy" 
                      alt="Lily Corinth"
                      onclick="uploadCommentProfilePic(this, 'lily')"
                      style="cursor: pointer;"
                      title="Click to change profile picture">
                    <span class="verified-icon flag tooltipTrig" data-title="Verified Model" onclick="toggleVerification(this)">
                      <img src="https://ei.phncdn.com/www-static/images/verified-badge.svg?cache=2025041602" alt="verified">
                    </span>
                  </a>
                </div>
                <div class="usernameWrap clearfix">
                  <span class="usernameBadgesWrapper">
                    <span class="username orange-name" contenteditable="true">Lily Corinth</span>
                    <i class="verified-icon userBadges spriteUi" data-title="Verified Model"></i>
                  </span>
                  <div class="date" contenteditable="true">1 month ago</div>
                </div>
              </div>

              <div class="commentMessage">
                <span contenteditable="true">Sometimes it feels hot leaving it on, like when a man just wants to go directly to fucking with no foreplay ðŸ¤¤</span>
                <div class="actionButtonsBlock">
                  <a class="gtm-event-watch-page tooltipTrig float-left commentBtn buttonClass generalBtn thumbsUp thumbs">
                    <i class="ph-icon-thumb-up"></i>
                  </a>
                  <span class="rightMargin float-left voteTotal" contenteditable="true">1</span>
                  <a class="tooltipTrig rightMargin float-left commentBtn buttonClass generalBtn thumbsDown thumbs">
                    <i class="ph-icon-thumb-down"></i>
                  </a>
                  <div class="rightMargin float-left replyBlock">
                    <a class="commentBtn buttonClass generalBtn reply">
                      <span>Reply</span>
                    </a>
                  </div>
                </div>
              </div>

              <div class="buttonBlockRight clearfix">
                <button data-title="Report" class="tooltipTrig commentBtn buttonClass generalBtn reportBtn flag float-left">
                  <i class="ph-icon-flag"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Second Reply -->
        <div class="clearfix">
          <div class="commentBlock closestComment clearfix">
            <div class="topCommentBlock clearfix">
              <div class="userWrap">
                <div class="boxUserComments">
                  <a class="userLink clearfix">
                    <img class="commentAvatarImg" 
                      src="https://ei.phncdn.com/pics/users/default/pornhub/(m=bJWsSeKlbyaT)(mh=4N6NZAtseWL0p9UF)male.jpg" 
                      loading="lazy" 
                      alt="Dickgolightly"
                      onclick="uploadCommentProfilePic(this, 'dick')"
                      style="cursor: pointer;"
                      title="Click to change profile picture">
                    <span class="toggle-verify-badge" onclick="toggleVerification(this)" title="Toggle verification badge">
                      <img src="https://ei.phncdn.com/www-static/images/verified-badge.svg?cache=2025041602" alt="verified">
                    </span>
                  </a>
                </div>
                <div class="usernameWrap clearfix">
                  <span class="usernameBadgesWrapper">
                    <span class="username orange-name" contenteditable="true">Dickgolightly</span>
                  </span>
                  <div class="date" contenteditable="true">2 years ago</div>
                </div>
              </div>

              <div class="commentMessage">
                <span contenteditable="true">he did, this is shortened version</span>
                <div class="actionButtonsBlock">
                  <a class="gtm-event-watch-page tooltipTrig float-left commentBtn buttonClass generalBtn thumbsUp thumbs">
                    <i class="ph-icon-thumb-up"></i>
                  </a>
                  <span class="rightMargin float-left voteTotal" contenteditable="true">10</span>
                  <a class="tooltipTrig rightMargin float-left commentBtn buttonClass generalBtn thumbsDown thumbs">
                    <i class="ph-icon-thumb-down"></i>
                  </a>
                  <div class="rightMargin float-left replyBlock">
                    <a class="commentBtn buttonClass generalBtn reply">
                      <span>Reply</span>
                    </a>
                  </div>
                </div>
              </div>

              <div class="buttonBlockRight clearfix">
                <button data-title="Report" class="tooltipTrig commentBtn buttonClass generalBtn reportBtn flag float-left">
                  <i class="ph-icon-flag"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- View All Replies Button -->
      <div class="viewAllReplies">
        <button class="viewRepliesBtn">
          <span>View All Replies (4)</span>
          <i class="ph-icon-chevron-down"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Base styles */
.comment-wrapper {
  width: 600px;
  max-width: 100%;
  margin: 0 auto;
  transition: width 0.3s ease;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 14px;
}

.comment-container {
  width: 100%;
  margin: 2rem auto;
  border: none;
  border-radius: 16px;
  padding: 1.5rem;
  background: #000000;
  color: #fff;
}

/* Comment blocks */
.commentBlock {
  padding: 10px;
  margin-bottom: 10px;
}

.nestedBlock {
  margin-left: 40px;
  border-left: 2px solid #292929;
  padding-left: 10px;
}

/* User info */
.userWrap {
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
}

.boxUserComments {
  margin-right: 10px;
}

.commentAvatarImg {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.usernameBadgesWrapper {
  display: flex;
  align-items: center;
  gap: 5px;
}

.username {
  font-weight: 700;
  font-size: 14px;
}

.username.unknown {
  color: #969696;
}

.username.orange-name {
  color: #ffa31a;
}

.date {
  color: #808080;
  font-size: 12px;
  margin-top: 2px;
}

/* Comment content */
.commentMessage {
  color: #b8b8b8;
  width: 87.5%;
  width: calc(100% - 72px);
  word-break: break-word;
  word-wrap: break-word;
  font-size: 14px;
}

.commentMessage span {
  font-size: 14px;
  line-height: 1.4;
}

/* Action buttons */
.actionButtonsBlock {
  display: flex;
  align-items: center;
  padding-top: .5em;
  width: 100%;
}

.float-left {
  float: none;
  display: flex;
  align-items: center;
}

.rightMargin {
  margin-right: 10px;
}

.commentBtn {
  background-color: transparent;
  border: 0;
  cursor: pointer;
  color: #969696;
  margin: 0;
  padding: 0;
  outline-style: none;
  text-decoration: none;
  display: flex;
  align-items: center;
}

.buttonClass.generalBtn {
  font-size: 13px;
  height: 18px;
  line-height: 18px;
  display: flex;
  align-items: center;
}

.thumbs {
  width: 18px;
  height: 18px;
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
}

.commentBtn:hover {
  color: #ffa31a;
}

.voteTotal {
  color: #969696;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 13px;
  display: flex;
  align-items: center;
  height: 18px;
  line-height: 18px;
}

.replyBlock {
  display: flex;
  align-items: center;
  height: 18px;
  line-height: 18px;
}

.replyBlock span {
  color: #969696;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 13px;
  font-weight: 700;
  display: flex;
  align-items: center;
}

.replyBlock span::before {
  content: "â€¢";
  font-size: 16px;
  margin: 0 8px;
  line-height: 13px;
}

/* Verified badge */
.userLink {
  position: relative;
}

.verified-icon.flag {
  position: absolute;
  bottom: -3px;
  right: -3px;
  width: 20px;
  height: 20px;
  background: #000000;
  border-radius: 50%;
  padding: 2px;
}

.verified-icon img {
  width: 100%;
  height: 100%;
  display: block;
}

.verified-icon.userBadges {
  width: 20px;
  height: 20px;
  display: inline-block;
  vertical-align: middle;
  margin-left: 4px;
}

/* Toggleable verification badge */
.toggle-verify-badge {
  position: absolute;
  bottom: -3px;
  right: -3px;
  width: 20px;
  height: 20px;
  background: #000000;
  border-radius: 50%;
  padding: 2px;
  opacity: 0;
  transition: opacity 0.2s ease;
  cursor: pointer;
}

.userLink:hover .toggle-verify-badge {
  opacity: 0.5;
}

.toggle-verify-badge:hover {
  opacity: 0.8 !important;
}

.toggle-verify-badge img {
  width: 100%;
  height: 100%;
  display: block;
}

/* Button block right */
.buttonBlockRight {
  float: right;
}

.reportBtn {
  color: #969696;
}

.reportBtn:hover {
  color: #ffa31a;
}

/* View All Replies */
.viewAllReplies {
  padding-left: 50px;
  margin-bottom: 10px;
  margin-top: 5px;
}

.viewRepliesBtn {
  background: none;
  border: none;
  color: #969696;
  font-size: 13px;
  font-family: Arial, Helvetica, sans-serif;
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  padding: 0;
}

.viewRepliesBtn:hover {
  color: #ffa31a;
}

/* Icons with direct SVG content for better preview */
.ph-icon-thumb-up {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23969696' d='M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z'/%3E%3C/svg%3E");
  width: 18px;
  height: 18px;
  display: inline-block;
  background-size: contain;
  background-repeat: no-repeat;
}

.ph-icon-thumb-down {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23969696' d='M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z'/%3E%3C/svg%3E");
  width: 18px;
  height: 18px;
  display: inline-block;
  background-size: contain;
  background-repeat: no-repeat;
}

.ph-icon-flag {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23969696' d='M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z'/%3E%3C/svg%3E");
  width: 18px;
  height: 18px;
  display: inline-block;
  background-size: contain;
  background-repeat: no-repeat;
}

.ph-icon-chevron-down {
  width: 14px;
  height: 14px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23969696' d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
  display: inline-block;
  background-size: contain;
  background-repeat: no-repeat;
}

/* Use embedded SVG for verification badge */
.verified-icon img {
  content: url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjAgMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMTAiIGZpbGw9IiNGRkEzMUEiLz48cGF0aCBkPSJNOC4xNSAxMy4zNUw1LjQ1IDEwLjY1bC0xLjEgMS4xTDguMTUgMTUuNTUgMTUuOCA3LjlsLTEuMS0xLjFMOC4xNSAxMy4zNXoiIGZpbGw9IiNGRkZGRkYiLz48L3N2Zz4=");
}

/* Add hover states for preview */
.thumbsUp:hover .ph-icon-thumb-up {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFA31A' d='M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z'/%3E%3C/svg%3E");
}

.thumbsDown:hover .ph-icon-thumb-down {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFA31A' d='M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z'/%3E%3C/svg%3E");
}

.reportBtn:hover .ph-icon-flag {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFA31A' d='M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z'/%3E%3C/svg%3E");
}

.viewRepliesBtn:hover .ph-icon-chevron-down {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFA31A' d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
}

/* Helper classes */
[contenteditable] {
  outline: none;
  padding: 2px 4px;
  border-radius: 4px;
}

[contenteditable]:hover {
  background: rgba(255, 255, 255, 0.1);
}

[contenteditable]:focus {
  background: rgba(255, 163, 26, 0.1);
  box-shadow: 0 0 0 2px rgba(255, 163, 26, 0.3);
}

.clearfix::after {
  content: "";
  display: table;
  clear: both;
}

.comment-controls {
  display: flex;
  gap: 1rem;
  margin-top: 1rem;
  align-items: center;
}

.preview-controls {
  display: flex;
  gap: 0.5rem;
}

.comment-preview-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  background: #ffa31a;
  color: #111;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.comment-preview-btn:hover {
  background: #ffb74d;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.comment-preview-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.randomize-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  background: #E7F3FF;
  color: #ffa31a;
}

.randomize-btn:hover {
  background: #ffa31a;
  color: #111;
}

/* Theme controls */
.theme-section {
  margin-bottom: 1rem;
}

.theme-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
}

.theme-selector {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.theme-toggle-group {
  display: flex;
  background: var(--bg-secondary);
  border-radius: 20px;
  padding: 0.25rem;
}

.theme-toggle {
  display: none;
}

.theme-toggle-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 0 0.15rem;
  color: var(--text-secondary);
}

.theme-toggle:checked + .theme-toggle-btn {
  background: #ffa31a;
  color: white;
}

.preview-controls {
  display: flex;
  gap: 0.5rem;
}

.preview-btn, .randomize-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
}

.preview-btn {
  background: #ffa31a;
  color: #111;
}

.preview-btn:hover {
  background: #ffb74d;
}

.randomize-btn {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.randomize-btn:hover {
  background: #ffa31a;
  color: #111;
}

/* Root variables */
:root {
  --accent-color: #ffa31a;
}
</style>

<script is:inline>
  function uploadCommentProfilePic(imgElement, userId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          // Initialize cropper with the image and handle the cropped result
          initImageCropper(e.target.result, 'comment-profile', (croppedImageUrl) => {
            // Update all instances of this user's profile picture
            document.querySelectorAll(`.commentAvatarImg[alt="${imgElement.alt}"]`).forEach(img => {
              img.src = croppedImageUrl;
            });
            console.log(`âœ… Successfully updated profile picture for ${userId}`);
          });
        };
        reader.readAsDataURL(file);
      }
    };
    input.click();
  }

  function toggleVerification(badgeElement) {
    // Get the parent user container
    const userLink = badgeElement.closest('.userLink');
    const userContainer = userLink.closest('.boxUserComments');
    const usernameElement = userLink.closest('.userWrap').querySelector('.username');
    
    // Check if the badge is a toggle-verify-badge or an active verified-icon
    const isToggleBadge = badgeElement.classList.contains('toggle-verify-badge');
    
    if (isToggleBadge) {
      // Activate the verification badge
      badgeElement.classList.remove('toggle-verify-badge');
      badgeElement.classList.add('verified-icon', 'flag', 'tooltipTrig');
      badgeElement.setAttribute('data-title', 'Verified Model');
      
      // Add verified-user class to the container
      userContainer.classList.add('verified-user');
      
      // Add orange color to username if not already
      if (!usernameElement.classList.contains('orange-name')) {
        usernameElement.classList.add('orange-name');
        if (usernameElement.classList.contains('unknown')) {
          usernameElement.classList.remove('unknown');
        }
      }
      
      // Add verified badge icon next to username if not present
      const usernameBadgesWrapper = usernameElement.closest('.usernameBadgesWrapper');
      if (!usernameBadgesWrapper.querySelector('.verified-icon.userBadges')) {
        const verifiedBadge = document.createElement('i');
        verifiedBadge.className = 'verified-icon userBadges spriteUi';
        verifiedBadge.setAttribute('data-title', 'Verified Model');
        usernameBadgesWrapper.appendChild(verifiedBadge);
      }
    } else {
      // Deactivate the verification badge
      badgeElement.classList.remove('verified-icon', 'flag', 'tooltipTrig');
      badgeElement.classList.add('toggle-verify-badge');
      badgeElement.removeAttribute('data-title');
      
      // Remove verified-user class from the container
      userContainer.classList.remove('verified-user');
      
      // Remove verified badge icon next to username
      const usernameBadgesWrapper = usernameElement.closest('.usernameBadgesWrapper');
      const verifiedBadge = usernameBadgesWrapper.querySelector('.verified-icon.userBadges');
      if (verifiedBadge) {
        verifiedBadge.remove();
      }
    }
    
    // Prevent the click from propagating to parent elements
    event.stopPropagation();
  }
  
  // Initialize all verification badges on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Make sure all verified badges are clickable
    document.querySelectorAll('.verified-icon.flag').forEach(badge => {
      if (!badge.hasAttribute('onclick')) {
        badge.setAttribute('onclick', 'toggleVerification(this)');
        badge.style.cursor = 'pointer';
      }
    });
  });

  function randomizeCommentStats() {
    // Randomize all voteTotal spans
    document.querySelectorAll('.voteTotal').forEach(el => {
      el.textContent = Math.floor(Math.random() * 1000);
    });
  }

  // Add theme change handler
  document.addEventListener('DOMContentLoaded', () => {
    // Add theme change handlers
    document.querySelectorAll('input[name="comment-theme"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          updateCommentTheme(target.value);
        }
      });
    });

    // Listen for main app theme changes
    document.querySelectorAll('input[name="theme"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          const theme = target.value;
          const commentContainer = document.querySelector('.comment-container');
          if (commentContainer) {
            commentContainer.setAttribute('data-theme', theme);
          }
          
          // Update comment theme radio buttons to match
          const commentThemeRadio = document.querySelector(`input[name="comment-theme"][value="${theme}"]`);
          if (commentThemeRadio && commentThemeRadio instanceof HTMLInputElement) {
            commentThemeRadio.checked = true;
          }
        }
      });
    });

    // Apply initial theme
    const checkedCommentTheme = document.querySelector('input[name="comment-theme"]:checked');
    if (checkedCommentTheme && checkedCommentTheme instanceof HTMLInputElement) {
      updateCommentTheme(checkedCommentTheme.value);
    }
  });

  function updateCommentTheme(theme) {
    console.log(`Updating comment theme to: ${theme}`);
    const container = document.querySelector('.comment-container');
    const appContainer = document.querySelector('.app-container');
    
    // Update comment container
    if (container) {
      container.setAttribute('data-theme', theme);
    }
    
    // Update app container theme
    if (appContainer) {
      appContainer.setAttribute('data-theme', theme);
      appContainer.setAttribute('data-platform', 'comment');
    }
    
    // Update the main theme radio buttons to match
    const mainThemeRadio = document.querySelector(`input[name="theme"][value="${theme}"]`);
    if (mainThemeRadio) {
      mainThemeRadio.checked = true;
      mainThemeRadio.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  // Function to ensure SVG icons render properly in the preview
  function showCommentPreviewModal(platform) {
    if (platform !== 'comment') return; // Only process for comments
    
    const modal = document.getElementById('previewModal');
    const previewContainer = document.getElementById('previewContainer');
    
    // Clear previous content
    if (previewContainer) {
      previewContainer.innerHTML = '';
    }
    
    // Get the original content
    const originalContainer = document.getElementById('cmtContent');
    if (!originalContainer) {
      console.error('Could not find the comment container for preview');
      return;
    }
    
    try {
      // Create a direct clone of the container
      const clonedContent = originalContainer.cloneNode(true);
      
      // Remove any interactive elements
      const interactiveElements = clonedContent.querySelectorAll('[onclick], [contenteditable], .dropdown-menu');
      interactiveElements.forEach(el => {
        if (el.hasAttribute('onclick')) el.removeAttribute('onclick');
        if (el.hasAttribute('contenteditable')) el.removeAttribute('contenteditable');
        if (el.classList.contains('dropdown-menu')) el.remove();
      });
      
      // Ensure proper styling for preview
      clonedContent.style.margin = '0 auto';
      clonedContent.style.maxWidth = '600px';
      
      // Make all icons visible by replacing with direct embedded SVG elements
      function replaceIconsWithSvg(iconClass, svgHTML) {
        const icons = clonedContent.querySelectorAll(`.${iconClass}`);
        icons.forEach(icon => {
          icon.innerHTML = svgHTML;
        });
      }
      
      // Replace thumb up icons
      replaceIconsWithSvg('ph-icon-thumb-up', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>');
      
      // Replace thumb down icons
      replaceIconsWithSvg('ph-icon-thumb-down', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>');
      
      // Replace flag icons
      replaceIconsWithSvg('ph-icon-flag', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>');
      
      // Replace chevron down icons
      replaceIconsWithSvg('ph-icon-chevron-down', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14"><path fill="#969696" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>');
      
      // Fix verification badges
      const verifiedBadges = clonedContent.querySelectorAll('.verified-icon img');
      verifiedBadges.forEach(badge => {
        badge.src = 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjAgMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMTAiIGZpbGw9IiNGRkEzMUEiLz48cGF0aCBkPSJNOC4xNSAxMy4zNUw1LjQ1IDEwLjY1bC0xLjEgMS4xTDguMTUgMTUuNTUgMTUuOCA3LjlsLTEuMS0xLjFMOC4xNSAxMy4zNXoiIGZpbGw9IiNGRkZGRkYiLz48L3N2Zz4=';
        badge.style.width = '100%';
        badge.style.height = '100%';
        badge.style.display = 'block';
      });
      
      // Append to preview container
      previewContainer.appendChild(clonedContent);
      
      // Show the modal
      if (modal) {
        modal.style.display = 'block';
      }
    } catch (error) {
      console.error('Error setting up comment preview:', error);
    }
  }

  // Expose our specialized function for comment previews
  window.showCommentPreviewModal = showCommentPreviewModal;

  // Modify downloadPreview function to better handle comments
  const originalDownloadPreview = window.downloadPreview;
  window.downloadPreview = async function() {
    const previewContainer = document.getElementById('previewContainer');
    const firstChild = previewContainer?.firstChild;
    
    // Check if we're downloading a comment preview
    if (firstChild && firstChild.id === 'cmtContent') {
      const button = document.querySelector('.modal-footer .btn-primary');
      const spinner = button.querySelector('.spinner-border');
      
      try {
        button.disabled = true;
        spinner.classList.remove('d-none');
        
        // Create a clean copy for high-quality capture
        const captureContainer = document.createElement('div');
        captureContainer.style.position = 'fixed';
        captureContainer.style.top = '0';
        captureContainer.style.left = '-9999px';
        captureContainer.style.background = document.body.getAttribute('data-theme') === 'dark' ? '#000000' : '#ffffff';
        captureContainer.style.zIndex = '-1000';
        document.body.appendChild(captureContainer);
        
        // Clone for high-quality capture
        const perfectClone = firstChild.cloneNode(true);
        perfectClone.style.transform = 'none';
        perfectClone.style.margin = '0';
        perfectClone.style.maxWidth = '600px';
        perfectClone.style.width = '600px';
        perfectClone.style.boxShadow = 'none';
        
        // Make all icons visible by replacing with direct embedded SVG elements
        function replaceIconsWithSvg(iconClass, svgHTML) {
          const icons = perfectClone.querySelectorAll(`.${iconClass}`);
          icons.forEach(icon => {
            icon.innerHTML = svgHTML;
          });
        }
        
        // Replace thumb up icons
        replaceIconsWithSvg('ph-icon-thumb-up', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>');
        
        // Replace thumb down icons
        replaceIconsWithSvg('ph-icon-thumb-down', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>');
        
        // Replace flag icons
        replaceIconsWithSvg('ph-icon-flag', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>');
        
        // Replace chevron down icons
        replaceIconsWithSvg('ph-icon-chevron-down', '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14"><path fill="#969696" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>');
        
        // Fix verification badges
        const verifiedBadges = perfectClone.querySelectorAll('.verified-icon img');
        verifiedBadges.forEach(badge => {
          badge.src = 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjAgMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMTAiIGZpbGw9IiNGRkEzMUEiLz48cGF0aCBkPSJNOC4xNSAxMy4zNUw1LjQ1IDEwLjY1bC0xLjEgMS4xTDguMTUgMTUuNTUgMTUuOCA3LjlsLTEuMS0xLjFMOC4xNSAxMy4zNXoiIGZpbGw9IiNGRkZGRkYiLz48L3N2Zz4=';
          badge.style.width = '100%';
          badge.style.height = '100%';
          badge.style.display = 'block';
        });
        
        captureContainer.appendChild(perfectClone);
        
        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Use html2canvas with best quality settings
        const canvas = await html2canvas(perfectClone, {
          scale: 4, // Higher scale for better quality
          useCORS: true,
          allowTaint: true,
          backgroundColor: document.body.getAttribute('data-theme') === 'dark' ? '#000000' : '#ffffff',
          logging: false,
          foreignObjectRendering: false, // Sometimes better for SVG rendering
          imageTimeout: 0, // No timeout for image loading
          onclone: (doc) => {
            // Additional handling for any on-the-fly fixes
            const clonedDoc = doc.querySelector('#cmtContent');
            if (clonedDoc) {
              // Make sure all SVG icons are visible
              const thumbIcons = clonedDoc.querySelectorAll('.ph-icon-thumb-up, .ph-icon-thumb-down, .ph-icon-flag, .ph-icon-chevron-down');
              thumbIcons.forEach(icon => {
                // If no SVG is present, create one
                if (!icon.querySelector('svg')) {
                  if (icon.classList.contains('ph-icon-thumb-up')) {
                    icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"/></svg>';
                  } else if (icon.classList.contains('ph-icon-thumb-down')) {
                    icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.01.01L1 14c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>';
                  } else if (icon.classList.contains('ph-icon-flag')) {
                    icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="#969696" d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>';
                  } else if (icon.classList.contains('ph-icon-chevron-down')) {
                    icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14"><path fill="#969696" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>';
                  }
                }
              });
              
              // Fix badges again to ensure they're visible
              const badges = clonedDoc.querySelectorAll('.verified-icon img');
              badges.forEach(badge => {
                badge.src = 'data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjAgMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMTAiIGZpbGw9IiNGRkEzMUEiLz48cGF0aCBkPSJNOC4xNSAxMy4zNUw1LjQ1IDEwLjY1bC0xLjEgMS4xTDguMTUgMTUuNTUgMTUuOCA3LjlsLTEuMS0xLjFMOC4xNSAxMy4zNXoiIGZpbGw9IiNGRkZGRkYiLz48L3N2Zz4=';
              });
            }
          }
        });
        
        // Convert to PNG with maximum quality
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/png', 1.0);
        });
        
        if (!blob) {
          throw new Error('Failed to create image blob');
        }
        
        // Download the image
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `comment-preview.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Revoke the URL to free memory
        setTimeout(() => {
          URL.revokeObjectURL(url);
        }, 100);
        
        // Clean up
        document.body.removeChild(captureContainer);
        
        closePreviewModal();
      } catch (error) {
        console.error('Error downloading comment preview:', error);
        alert('Failed to download preview. Please try again.');
      } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
      }
    } else {
      // Use original function for other platforms
      return originalDownloadPreview();
    }
  };
</script>